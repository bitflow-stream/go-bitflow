# Bitflow Script Antlr implementation

## Implementation approach

### Overview

The Listener pattern of ANTLR is used, not the Visitor pattern, because the Golang version of the visitor pattern is not
functioning yet. [See Github](https://github.com/antlr/antlr4/pull/1807)
 
- **internal** package: contains the code generated by ANTLR.
- **parser.go**: the parser implementation, takes a bitflow script and returns an executable pipeline
- **generic_stack.go**: used for agent parser, see below

### State and GenericStack

The agent_parser implements the antlr listener of the bitflow script grammar.
Instances of GenericStack are used to keep the state while building nested pipelines.
If state needs to be stored, it is pushed onto the appropriate stack and popped when not used anymore.
This works well, because the listener moves through the AST using a DEPTH FIRST algorithm. Therefore nested Forks, Windows, etc. naturally work until the physical memory is full.

Example with a fork:
```
   Enter Fork:                      Push empty list to the forkedSubPipelines stack
	    EnterNamedSubPipeline:      Push empty pipeline on the pipeline stack 
		      EnterTransform:       -
		      ExitTransform:        Add transform to the pipeline on top of stack, which is the pushed subpipeline
	    ExitNamedSubPipeline:       pop last subpipeline from stack and add it to the list at the top of the forkedSubPipelines stack
	    EnterNamedSubPipeline:      Push empty subpipeline on the pipeline stack
		      ...create subpipe...  -
	    ExitNamedSubPipeline:       pop last subpipeline from stack and add it to the list at the top of the forkedSubPipelines stack
    Exit Fork:                      create Fork with all subpipelines from the top of forkedSubPipelines
```
